---
title: "Hvordan læses stykkerne ind i R?"
output: html_notebook
author: pmd
---
Stykkerne er i TEI format. Dette format har ikke en standard indlæsningsmetod til R. Derfor transformerer vi TEI filerne over i et format der bedre passer til R. Vi har her valgt JSONL, men kunne have valgt andre formater. I JSONL formatet er hver linie i sig selv en stump valid JSON, mens filen som et hele ikke er valid JSON. Dette gør, at hver linie kan læses uafhængigt af hele filen.

For at gøre dette nemt, har vi skrevet to små R funktioner. En der transformerer alle TEI filer i en mappe og en der indlæser alle JSONL filer i en mappe til R. TEI filer er identificeret ved at deres filnanv ender med ".page".

Denne notebook illustrerer brugen af disse to funktioner.

Før vi starter skal vi indlæse de nødvendige udvidelsespakker til R.

```{r, message=FALSE}
library(tidyverse)
library(ndjson)
library(here)
library(fs)
library(xslt)
```

De to hjælpefunktioner er defineret i `src/p017-functions.R`, som vi indlæser på følgende vis

```{r}
source(here("src", "p017-functions.R"))
```

# Transformation af TEI filer

Vi har placeret to testfiler i mappen `test-data`
Nu prøver jeg også lige at køre det på hele 'data/holberg-komedier-nc'

```{r}
dir_ls(here("test-data"))
```

For at transformere disse to filer, gør vi følgende

```{r}
convert_TEI_to_JSONL(here("test-data"))
```

Hvis vi nu igen ser i mappen `test-data`, kan vi se at der er kommet to nye filer

```{r}
dir_ls(here("test-data"))
```

# Indlæsning af JSONL filer til R

Vi kan nu indlæse de to nye JSONL filer på følgende vis

```{r}
read_plays_jsonl(here("test-data")) -> plays
```

Lad os kort se på fx hvor mange rækker, vi har i hvert af de to skuespil.
Rækker er her ikke så meningsgivende, da det både kan være replikker og regibemærkninger.
Lad os derfor også prøve at finde antal replikker og antal regibemærkninger!

```{r}
# Tæl antal rækker
plays %>% 
  count(title, name = "# rækker")

# Tæl antal replikker
plays %>%
  filter(!is.na(spoke)) %>% #filtrer replikker markeret NA ud
  filter(!(spoke == "")) %>% #filtrer tomme replikker ud
  count(title, name = "# replikker")

# Tæl antal regibemærkninger
# bemærk de findes på to niveauer, så i første omgang tæller vi dem hver for sig
# Tæl antal <stage>
plays %>%
  filter(!is.na(stage)) %>% #filtrer stage markeret NA ud
  filter(!(stage == "")) %>% #filtrer tomme stage ud
  count(title, name = "# stage")
# Tæl antal <speaker_stage>
plays %>%
  filter(!is.na(speaker_stage)) %>% #filtrer speaker_stage markeret NA ud
  filter(!(speaker_stage == "")) %>% #filtrer tomme speaker_stage ud
  count(title, name = "# speaker_stage")
```
# Indlæsning af en enkelt JSONL fil til R

Der har været noget bøvl med titler på stykkerne, som sjældent er hvad vi forventer, hvis de altså overhovedet er der, derfor har vi indført en funktion, som indlæser et enkelt stykke fra JSONL filen.

```{r}
#Funtionen her henter det skuespil, der er i den navngavne JSONL fil
read_play_jsonl(here("test-data", "Den_Vaegelsindede_1731_mod_nc.jsonl")) -> play
play #se den tbl, der nu er last ind i play

```

Og så tager vi lige den med antal replikker igen!


```{r}
# Tæl antal rækker
play %>% count(filename, name = "# rækker")

# Tæl antal replikker
play %>%
  filter(!is.na(spoke)) %>% #filtrer replikker markeret NA ud
  filter(!(spoke == "")) %>% #filtrer tomme replikker ud
  count(filename, name = "# replikker")

# Tæl antal regibemærkninger
# bemærk de findes på to niveauer, så i første omgang tæller vi dem hver for sig
# Tæl antal <stage>
play %>%
  filter(!is.na(stage)) %>% #filtrer stage markeret NA ud
  filter(!(stage == "")) %>% #filtrer tomme stage ud
  count(filename, name = "# stage")
# Tæl antal <speaker_stage>
play %>%
  filter(!is.na(speaker_stage)) %>% #filtrer speaker_stage markeret NA ud
  filter(!(speaker_stage == "")) %>% #filtrer tomme speaker_stage ud
  count(filename, name = "# speaker_stage")
```

