---
title: "Updating the allspeakers_gender and mask sheet"
output: html_notebook
date: 2021-09-09
author: pmd
---

```{r}
library(tidyverse)
library(readxl)
library(here)
```


# Indledning

Det vi har brug for:

 - DONE indlæse arket
 - finde Bolettes kode
 - ændre Bolettes kode til tidy format
 - vi skal sikre at vi kan oprette arket, tilføje manuelle data og genopdatere arket i R
 - kombinerer vores udgave med den oprindelige
 
# Spørgsmål

 - Hvad er en "speaker" i regnearket?

# Indlæsning af de manuelle data


```{r}
manual_all_plays <- read_excel(here("allspeakers_gender_and_mask.xlsx"))
```
```{r}
manual_all_plays
```
```{r}
sheet %>%
        count(`Dramaturgic function`)
```


# Bolettes kode
# Sandkasse

```{r}
read_csv(here("output/find_speakers/barselstuen_speakers.csv")) %>% 
        filter(is.na(speaker)) %>% 
        select(speaker_stage) %>% 
        filter(!is.na(speaker_stage))
```
## Calculate the automatic table

Oprindelig kode fra Bolette

```{r}
allplays %>% 
  count(speaker, docTitle, year) %>%
  group_by(speaker) %>%
  mutate(count_speaker = sum(n)) %>%
  count(docTitle, count_speaker) %>%
  summarise(plays = toString(unique(docTitle)), count_speaker, count_plays = sum(n)) %>%
  unique()
```

Vi skal ikke gruppere på `speaker`

```{r}
allplays %>% 
        count(speaker, docTitle) %>% 
        rename(plays = docTitle)-> auto_all_plays
auto_all_plays
```


# Kombiner de to ark

Vi har denne struktur fra det manuelle ark:

```
# A tibble: 343 x 10
    ...1 speaker plays count mask  gender `main character… `Dramaturgic fu… Notes
   <dbl> <chr>   <chr> <dbl> <chr> <chr>  <chr>            <lgl>            <chr>
 1     1 .       ARTA…     1 NA    NA     NA               NA               Bole…
 2     2 1.      Den …     8 NA    NA     NA               NA               Bole…
 3     3 1. adv… Bars…    87 Acad… m      NA               NA               NA  
```

og denne automatisk skabte tabel

```
# A tibble: 600 x 3
   speaker               docTitle                                         n
   <chr>                 <chr>                                        <int>
 1 1.                    Den politiske kandestøber Komedie                8
 2 1. advokat            Barselsstuen Komedie                            28
 3 1. advokat            Den politiske kandestøber Komedie               22
```

Vi skal først have `manual_all_plays` på "tidy" form, dvs. splittet plays, som er en komma adskilt liste, op i en række pr. stykke, samtidig med at vi bibeholder alle kolonner efter `count`.

```{r}
manual_all_plays %>% 
        separate_rows(plays,sep = ",") %>% 
        select(-`...1`) # hvor kommer denne kolonne fra?
```
Vi kan nu — måske — flette de to tabeller

```{r}
auto_all_plays %>% 
        left_join(manual_all_plays, by = c("speaker", "plays"))
```

```{r}
glimpse(.Last.value)
```


