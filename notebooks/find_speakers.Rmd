---
title: "Speakers"
output: html_notebook
author: baj
---

Netværk
Opdel alle på titel, akt og scene.
Vi vil gerne nå frem til en grafisk fremstilling af netværk.

Lige nu håber jeg at Per kigger på det med at indlæse alle stykkerne.
Her ser jeg på et ad gangen.

# Read a play into R

Load the JSONL data format

```{r}
library(tidyverse)
library(ndjson)
library(here)
library(fs)
library(tidytext)

barselstuen_raw <- ndjson::stream_in(here("test-data/Barselstuen_mod.jsonl")) %>% tibble()
read_plays_jsonl (here("test-data")) ->allplays
```

# Looking at the data

```{r}
 barselstuen_raw
```
Vi kan også gemme jsonl filen som csv direkte:

```{r}
 write.csv(barselstuen_raw, file = here("test-data/output/barselstuen.csv"))

```



##Find navne på alle karakterer med replikker.
Tæl alle navngivne karakterer med replikker.

Vi kan lave en liste af speakers. Antallet vil så bare være længden af listen - med det forbehold at nogle af dem i listen muligvis er den samme. Det kan være vi kan bruge ordbogen til at lægge nogle af dem sammen...

Vi kan også lave et skema med speakers opdelt på akt og scene...

```{r}
here()

all_speakers <- allplays %>% 
  count(speaker)
all_speakers
# get column names
colnames(all_speakers)
write.csv(all_speakers, file = here("test-data/output/allspeakers.csv"))

#skal kun bruges, når vi kører ét stykke ad gangen
speakers_by_scene <- allplays %>% 
  count(act, scene, speaker)
speakers_by_scene
write.csv(speakers_by_scene, file = here("test-data/output/speakers_by_scene.csv"))
```
Next we load and run the excel sheet
```{r}
(variants <- read_excel(here("Rolleliste.xlsx")) %>% 
  unnest_tokens(variant, Alias, token = "regex", pattern = ", ") %>% 
    mutate(
      Karakter = tolower(Karakter),
      variant = tolower(variant)
    ))
# "sammenlæg navnevarianter" (se "use-excel-for-name-variants.Rmd")
# Husk at bruge Filnavn
(allplays %>% 
  mutate(speaker = tolower(speaker)) %>% 
  left_join(variants, by = c("speaker"="variant")) %>% 
  mutate(speaker = if_else(!is.na(Karakter), Karakter, speaker)) %>%
      filter(!is.na(speaker), !(speaker=="")) %>%
distinct -> allplays)

all_speakers <- allplays %>% 
  count(speaker)
all_speakers
# get column names
colnames(all_speakers)
write.csv(all_speakers, file = here("test-data/output/allspeakers uden navnevarianter.csv"))



```

Der er godt nok mange! Og der er også nogle mærkværdigheder. Spørgsmålet er om de kommer fra TEI-filen eller fra oversættelsen?

##Find navne på alle karakterer, som kun nævnes i regibemærkninger.
Tæl karakterer, som kun nævnes i regibemærkninger.

Til at starte med kan vi finde alle regi-bemærkninger. De findes i <stage> og <speaker_stage>.

```{r}
# <stage>
all_stage_instructions <- barselstuen_raw %>%
  select(stage) %>% filter(!is.na(stage))
all_stage_instructions
# write.csv(all_stage_instructions, file = here("test-data/output/barselstuen_all_stage_instructions.csv"))

# <speaker-stage>
all_speaker_stage_instructions <- barselstuen_raw %>%
  select(speaker_stage) %>% filter(!is.na(speaker_stage))
all_speaker_stage_instructions

# combine vectors
combined_stage_vector <- c(as.vector(all_stage_instructions[['stage']]), as.vector(all_speaker_stage_instructions[['speaker_stage']]))
combined_stage_vector
write.csv(combined_stage_vector, here("test-data/output/barselstuen_combined_stage_instructions.csv"))

# <stage> by <scene>
stage_instructions_by_scene <- barselstuen_raw %>%
  select(act, scene, stage) %>% filter(!is.na(stage))
stage_instructions_by_scene
write.csv(stage_instructions_by_scene, file = here("test-data/output/barselstuen_stage_instructions_by_scene.csv"))

# <speaker-stage> by <scene>
speaker_stage_instructions_by_scene <- barselstuen_raw %>%
  select(act, scene, speaker_stage) %>% filter(!is.na(speaker_stage))
speaker_stage_instructions_by_scene
write.csv(speaker_stage_instructions_by_scene, file = here("test-data/output/barselstuen_speaker_stage_instructions_by_scene.csv"))

```

Der er altså 131 + 54 = 185 regibemærkninger i dette stykke. Vi mangler at finde karaktererne. Det kan gøres med et søge-udtryk, hvis vi ved hvad vi skal søge efter. 
Vi kan søge efter de karakterer,vi fandt i <speaker>, men så kan det være at vi misser nogen, som er til stede, men ikke taler.
Vi kan finde dem med manuelt arbejde.
Vi kan måske bruge ordbogen.

