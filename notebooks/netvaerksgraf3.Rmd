---
title: "Netværksgraf 3 med vægte"
author: "Bolette A. Jurik"
date: "2/3-2021"
output: html_notebook
---

This version also uses the functions in "graph_functions.R".

First we load the libraries and source the functions.
```{r, message=FALSE}
library(here)
library(xml2)
library(tidyverse)
library(ndjson)
library(here)
library(fs)
library(xslt)
library(tidytext)
library(ggraph)
library(igraph)
library(tidygraph)
library(readxl)

source(here("src", "p017-functions.R"))
source(here("src", "graph_functions.R"))
source(here("src", "present_without_speech.R"))
```

Next we load the excel sheet
```{r}
variants <- read_excel(here("Rolleliste.xlsx")) %>% 
    unnest_tokens(variant, Alias) %>% 
    mutate(
      Karakter = tolower(Karakter),
      variant = tolower(variant)
    )
```

# Find Speakers and Weights
Put the name of the file to use in "my_file".

Vægtene er "spoken words" ligesom i "visualisering-ord-sagt.Rmd" - eller næsten ligesom. I stedet for at tælle ord for hver speaker, tæller vi denne gang ord for hver scene...

```{r}
# indlæs stykke
my_file <- "Barselstuen_mod_nc.jsonl"
(read_play_jsonl(here("test-data", my_file)) -> play)

# "sammenlægge navnevarianter" (se "use-excel-for-name-variants.Rmd")
(play %>% 
  mutate(speaker = tolower(speaker)) %>% 
  left_join(variants, by = c("speaker"="variant")) %>% 
  mutate(speaker = if_else(!is.na(Karakter), Karakter, speaker)) %>%
  select(-Karakter, -Filnavn) -> play)

# find speakers using function
(find_speakers(play) -> distinct_speakers)

# og find vægte
(play %>%
  mutate(n_spoken_words = str_count(spoke, '\\w+')) %>% 
  select(n_spoken_words, everything()) %>%
  filter(!is.na(speaker)) %>%
  filter(!(speaker == "")) %>%
  filter(!is.na(n_spoken_words)) %>%
  select(n_spoken_words, speaker, act_number, scene_number) %>% 
  group_by(act_number, scene_number)  %>%
  summarise(words = sum(n_spoken_words), act_number, scene_number, speaker) %>%
  distinct() -> scene_weights)
```

# Find Nodes and Edges and combine with weights 
```{r}
# find nodes using function
(speakers2nodes(distinct_speakers) -> nodes_play)

# find edges and combine edges with weights
# (trouble when finding the edges using the function,
# we discarded act and scene;
# lets try finding them here instead)

#create column 'speaker2' and make it equal to 'speaker' (duplicate).
  distinct_speakers$speaker2 = distinct_speakers$speaker 
  # All possible combinations (remember the data is still grouped by act-number and scene-number)
  distinct_speakers %>% 
    expand(speaker, speaker2) -> who_speaks_to_whom
  
  (who_speaks_to_whom  %>%
      ungroup() %>%
      select(from = speaker, to = speaker2) %>%
      distinct() -> edges_play)

(who_speaks_to_whom %>% right_join(scene_weights) -> who_speaks_to_whom_with_weights)
  
(who_speaks_to_whom_with_weights  %>%
  summarise(from = speaker, to = speaker2, weight = sum(words)) %>%
  ungroup() %>%
  select(from, to, weight) %>%
  group_by(from, to) %>%
  summarise(from , to , ord_sagt = sum(weight)) %>%
    distinct() -> edges_weights)
```
# Draw first graph
We can now draw a graph with weighted edges like this.
```{r}
gr1 <- tbl_graph(nodes = nodes_play, edges = edges_weights, directed = TRUE, node_key = "speaker")

ggraph(gr1, layout = 'kk') + 
    geom_edge_link(aes(start_cap = label_rect(node1.speaker),
                       end_cap = label_rect(node2.speaker),
                       width = ord_sagt),
                   alpha = .25) + 
    geom_node_text(aes(label = speaker)) + 
    labs(caption = paste("Netværksgraf", my_file))
```
Ok, det virker!
Men jeg tror jeg har talt forkert igen, for der er nok ikke nogen, der siger 80000 ord...

Så vil vi prøve at tilføje stumme karakterer med stiplede kanter.

# Find the characters that are present but do not speak
```{r}
(present_without_speech(play) -> present_but_silent)
```
