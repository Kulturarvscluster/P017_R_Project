---
title: "Netværksgraf 3 med vægte og karakterer, som ikke taler, men er til stede"
author: "Bolette A. Jurik"
date: "2/3-2021"
output: html_notebook
---

This version also uses the functions in "graph_functions.R".

First we load the libraries and source the functions.
```{r, message=FALSE}
library(here)
library(xml2)
library(tidyverse)
library(ndjson)
library(here)
library(fs)
library(xslt)
library(tidytext)
library(ggraph)
library(igraph)
library(tidygraph)
library(readxl)

source(here("src", "p017-functions.R"))
source(here("src", "graph_functions.R"))
source(here("src", "present_without_speech.R"))
```

Next we load the excel sheet
```{r}
(variants <- read_excel(here("Rolleliste.xlsx")) %>% 
  unnest_tokens(variant, Alias, token = "regex", pattern = ", ") %>% 
    mutate(
      Karakter = tolower(Karakter),
      variant = tolower(variant)
    ))
```

# Find Speakers and Weights
Put the name of the file to use in "my_file".

Vægtene er "spoken words" ligesom i "visualisering-ord-sagt.Rmd" - eller næsten ligesom. I stedet for at tælle ord for hver speaker, tæller vi denne gang ord for hver scene...

```{r}
# The next line is only necessary if you do not already have the jsonl files
# convert_TEI_to_JSONL(here("test-data"))

# my_file <- "GertWestphaler1724_mod.jsonl"
my_file <- "Mascarade_mod.jsonl"
# my_file <- "Barselstuen_mod.jsonl"

(read_play_jsonl(here("test-data", my_file)) -> play)

# "sammenlægge navnevarianter" (se "use-excel-for-name-variants.Rmd")
# Husk at bruge Filnavn
(play %>% 
  mutate(speaker = tolower(speaker)) %>% 
  left_join(variants, by = c("filename"="Filnavn", "speaker"="variant")) %>% 
  mutate(speaker = if_else(!is.na(Karakter), Karakter, speaker)) %>%
      filter(!is.na(speaker), !(speaker=="")) %>%
distinct -> play)

# find speakers using function
(find_speakers(play) -> distinct_speakers)

# og find vægte
play %>%
  mutate(n_spoken_words = str_count(spoke, '\\w+')) %>% 
  select(n_spoken_words, everything()) %>%
  filter(!is.na(speaker)) %>%
  filter(!(speaker == "")) %>%
  filter(!is.na(n_spoken_words)) %>%
  select(n_spoken_words, speaker, act_number, scene_number, act, scene) %>% 
  group_by(act_number, scene_number)  %>%
  summarise(words = sum(n_spoken_words), act_number, scene_number, act, scene, speaker) %>%
  distinct() -> scene_weights
```

# Find Nodes and Edges and combine with weights 

Ok. Det jeg gerne vil i linje ca. 78 til 113 er at finde vægte til kanter. Der er en kant mellem 2 personer, hvis de begge to har haft en replik i samme scene. vægten på den kant er antallet af ord sagt i den scene. Hvis to personer har talt sammen i flere scener, lægger vi antallet af ord sagt i hver af scenerne sammen, og det er så vægten på kanten. Jeg havde en fejl med antallet af kanter, men den tror jeg, jeg har fikset nu. Så er næste spørgsmål om jeg så har regnet vægtene rigtigt - og om det ikke kan skrives lidt mere læseligt 


```{r}
# find nodes using function
(speakers2nodes(distinct_speakers) -> nodes_play)

# find edges and combine edges with weights
# (trouble when finding the edges using the function,
# we discarded act and scene;
# lets try finding them here instead)

#create column 'speaker2' and make it equal to 'speaker' (duplicate).
distinct_speakers$speaker2 = distinct_speakers$speaker 
  
# All possible combinations (remember the data is still grouped by act-number and scene-number)
distinct_speakers %>% 
    expand(speaker, speaker2) %>%
    # fjern selvreferencer
    filter(speaker != speaker2) -> who_speaks_to_whom
  
(who_speaks_to_whom  %>%
      ungroup() %>%
      # fjern kant i den ene retning
      filter(speaker < speaker2) %>% 
      select(from = speaker, to = speaker2) %>%
      distinct() -> edges_play)

# Kombiner med vægte
(who_speaks_to_whom %>% right_join(scene_weights) -> who_speaks_to_whom_with_weights)
  
# Opsumér vægte
(who_speaks_to_whom_with_weights  %>%
    ungroup() %>% 
    rename(from=speaker, to=speaker2) %>% 
    select(from,to,words) %>% 
    filter(!is.na(to)) %>% 
    group_by(from,to) %>% 
    arrange(from,to,words) %>% 
    mutate(weight=sum(words)) %>% 
    ungroup() %>% 
    select(from,to,weight) %>% 
      filter(from < to) %>% # fjern kant i den ene retning
    distinct() -> edges_weights)
# ungroup,rename,select,filter are just data wrangling
# We group by from,to.
# Arrange is just for display purposes
# Mutate weight=sum(words) sums in each group
# We can then ungroup
# select removes unnessesary columns
# distinct ensures that each edge exists just once    

# Kan det nu passe?
(who_speaks_to_whom_with_weights %>%
  # filtrer på kun to roller
  filter(speaker == "henrik", speaker2 == "pernille"))
  

```

# Draw first graph
We can now draw a graph with weighted edges like this.
```{r}
nodes_play
edges_weights
gr1 <- tbl_graph(nodes = nodes_play, edges = edges_weights, directed = FALSE, node_key = "speaker")

(ggraph(gr1, layout = 'stress') + 
    geom_edge_link(aes(start_cap = label_rect(node1.speaker),
                       end_cap = label_rect(node2.speaker),
                       width = weight
                       ),
                   alpha = .25) + 
    geom_node_text(aes(label = speaker)) + 
    labs(caption = paste("Netværksgraf", my_file)))
```
Så vil vi prøve at tilføje stumme karakterer med stiplede kanter.

# Find the characters that are present but do not speak
```{r}
# genindlæs skuespil, for så virker det!
play <- read_play_jsonl(here("test-data", my_file))
(present_without_speech(play) -> present_but_silent)
# Her skal vi også have sat vægte på
# Det kan vi gøre ud fra act_number og scene_number igen
(present_but_silent %>% left_join(scene_weights) %>%
    distinct() -> present_but_silent_with_weights)

# combine with speakers by act and scene and rename
(present_but_silent_with_weights %>%
    rename(from=word, to=speaker) %>% 
  select(from,to,words) %>% 
  filter(!is.na(to)) %>% 
  group_by(from,to) %>% 
  arrange(from,to,words) %>% 
    distinct() %>%
  mutate(weight=sum(words)) -> tmp)
(tmp %>% 
  ungroup() %>% 
  select(from,to,weight) %>% 
  distinct() -> silent_edges_with_weights)

  
```
Det her virker for "GertWestphaler1724_mod.jsonl", men nok ikke alle!
Det virker "nogen gange"?!?!

# Draw second graph
We can now combine the two sets of weighted edges and draw a graph like this.
```{r}
edges_weights$type = "sp"

silent_edges_with_weights$type = "sq"

(silent_edges_with_weights %>% bind_rows(edges_weights) -> edges_combined) 

gr1 <- tbl_graph(nodes = nodes_play, edges = edges_combined, directed = FALSE, node_key = "speaker")

ggraph(gr1, layout = 'stress') + 
    geom_edge_fan(aes(start_cap = label_rect(node1.speaker),
                       end_cap = label_rect(node2.speaker),
                       width = weight,
                       colour = factor(type)),
                   alpha = .25) + 
    geom_node_text(aes(label = speaker)) +  
    labs(caption = paste("Netværksgraf", my_file))

# Create a PNG file for the graph (`mypng.png`)
# ggsave(here("test-data", "mygraph.png"))

```
