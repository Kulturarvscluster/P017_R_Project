---
title: "Hvem er til stede uden replikker?"
output: html_notebook
author: baj
---

# Bestemmelse af hvem der ikke siger noget men er tilstede 

Dette gøres ud fra regi-bemærkninger 


Before we start, we need to load the needed R packages

```{r, message=FALSE}
library(tidyverse)
library(ndjson)
library(here)
library(fs)
library(xslt)
library(tidytext)
```

We also need to load the functions created for this project. This is done by `source`-ing them.

```{r}
source(here("src", "p017-functions.R"))
source(here("src", "present_without_speech.R"))
```


# Read plays

(Look at read-plays.Rmd for help)

```{r}
convert_TEI_to_JSONL(here("data", "holberg-komedier-nc"))
plays <- read_plays_jsonl(here("data", "holberg-komedier-nc"))
plays
```

# Find speakers
We look at one play at a time.

Play is now the play in question. This way, you can just change that and rerun all the sections below, without having to change them.
```{r}
(plays %>%
  filter(title == " Barselsstuen") -> play)
```

Find all designated speakers
```{r}
(play %>%
  filter(!is.na(speaker)) %>% 
  count(speaker) %>%
  mutate(speaker = str_to_lower(speaker)) %>%
  select(speaker) -> speakers)
```

# Find alle regi-bemærkninger. 
De findes i <stage> og <speaker_stage>.

```{r}
(play %>% 
  unnest_tokens(word, stage) %>% #tokenize stage
  filter(!is.na(word)) %>%
  select(act, scene, index, word) -> stage_tokens)

(play %>% 
  unnest_tokens(word, speaker_stage) %>% #tokenize speaker stage
  filter(!is.na(word)) %>%
  select(act, scene, index, word) -> speaker_stage_tokens)
```

# Search for speakers in instructions
```{r}
(stage_tokens %>%
  semi_join(speakers, by = c("word" = "speaker")) -> speakers_in_stage)

(speaker_stage_tokens %>%
  semi_join(speakers, by = c("word" = "speaker")) -> speakers_in_speaker_stage)

(speakers_in_stage %>%
    full_join(speakers_in_speaker_stage) -> all_speakers_in_stage)

```
Ovenstående må betyde at vi har 112 steder, hvor en speaker er nævnt i en regi-bemærkning.
Altså ud fra den liste af speakers, som vi véd er med stykket. 

# Remove the speakers, that are actually speaking?!
Maybe we should have filtered them out earlier, but here goes
```{r}
         
## Distinct speakers in each scene in each act   
(play %>% 
  filter(!is.na(speaker)) %>%
  select(act, scene, speaker) %>%
  mutate(speaker = str_to_lower(speaker)) %>%
  distinct() -> distinct_speakers)
all_speakers_in_stage

## Filter out speakers from words grouped by act and scene!
all_speakers_in_stage %>%
  anti_join(distinct_speakers, by=c("act"="act", "scene"="scene", "word"="speaker")) %>% 
  distinct()

```

Hov, er der slet ikke nogen tilbage nu?

```{r}
# Sanity check
all_speakers_in_stage %>%
  group_by(act, scene) %>%
  semi_join(distinct_speakers, by = c("word" = "speaker"))

```

Hvis det skal bruges i grafen, skal vi lave det hele til en funktion.

Så kan vi også prøve funktionen på et andet skuespil, og måske få et andet resultat?!

# Test Function

```{r}
present_without_speech(" Husspøgelse")
```

Same result?!
Find known example!
Barselstuen, akt 2, scene 2: 
```{r}
(play
  count(speaker) %>%
  mutate(speaker = str_to_lower(speaker)) %>%
  select(speaker) -> speakers)

(play %>%
  filter(act_number == 2, scene_number == 2) %>%
  count(speaker) %>%
  mutate(speaker = str_to_lower(speaker)) %>%
  select(speaker) -> speakers_a2s2)

(play %>%
  filter(act_number == 2, scene_number == 2) %>% 
  unnest_tokens(word, stage) %>% #tokenize stage
  filter(!is.na(word)) %>%
  select(act, scene, index, word) -> stage_tokens_a2s2)

(play %>%
  filter(act_number == 2, scene_number == 2) %>% 
  unnest_tokens(word, speaker_stage) %>% #tokenize speaker stage
  filter(!is.na(word)) %>%
  select(act, scene, index, word) -> speaker_stage_tokens_a2s2)

## Distinct speakers in each scene in each act   
(play %>%
  filter(!is.na(speaker)) %>%
  select(act, scene, speaker) %>%
  mutate(speaker = str_to_lower(speaker)) %>%
  group_by(act, scene)  %>%
  distinct() -> distinct_speakers)

## Filter out speakers from all words
(stage_tokens_a2s2 %>%
  group_by(act, scene) %>%
  semi_join(speakers, by = c("word" = "speaker")) -> speakers_in_words)

## Then filter out speakers who speak grouped by act and scene!
speakers_in_words %>%
  group_by(act, scene) %>%
  anti_join(speakers_a2s2, by = c("word" = "speaker"))

```
Now, this was as expected. We found corfitz! Now we should make this work for the full play somehow!


WORK IN PROGRESS


Dernæst brug en bruttoliste over hvem der ville kunne være tilstede 

Denne bruttoliste kan måske baseres på "ordbogen"

Den kan måske gives fra forskerne 