---
title: "Hvem er til stede uden replikker?"
output: html_notebook
author: baj
---

# Bestemmelse af hvem der ikke siger noget men er tilstede 

Dette gøres ud fra regi-bemærkninger 

```{r}
library(tidyverse)
library(ndjson)
library(here)

source(here("src/read_play_function.R"))

```


# Read all plays
Den her blok er lige nu lidt lang, men skal helst erstattes med en one-liner på et tidspunkt!

```{r}
tei_file_list <- list.files(here("/data/holberg-komedier-nc/"), pattern = "*.page")
length(tei_file_list)

json_file_list <- list.files(here("/data/holberg-komedier-nc/json/"))
length(json_file_list)

one_play <- read_play(str_c("/data/holberg-komedier-nc/",tei_file_list[1]), 
                       str_c("/data/holberg-komedier-nc/json/",json_file_list[1]))

all_plays <- read_play(str_c("/data/holberg-komedier-nc/",tei_file_list[1]), 
                       str_c("/data/holberg-komedier-nc/json/",json_file_list[1]))

for(i in 2:length(tei_file_list)) {
  tmp <- read_play(str_c("/data/holberg-komedier-nc/",tei_file_list[i]),
                   str_c("/data/holberg-komedier-nc/json/",json_file_list[i]))
  all_plays <- bind_rows(all_plays, tmp)
}

all_plays
```

# Find alle regi-bemærkninger. 
De findes i <stage> og <speaker_stage>.

```{r}
# One play - maybe this should be a function
stage_one <- one_play %>%
  select(act, act_number, scene, scene_number, index, stage) %>% filter(!is.na(stage))
speaker_stage_one <- one_play %>%
    select(act, act_number, scene, scene_number, index, speaker_stage) %>% filter(!is.na(speaker_stage))
instruction_one <- bind_rows(stage_one, speaker_stage_one)
instruction_one_by_scene <- arrange(instruction_one, act_number, scene_number, index)
instruction_one_by_scene

# All Plays
# <stage> by <scene>
stage_instructions_by_scene <- all_plays %>%
  select(title, act, act_number, scene, scene_number, index, stage) %>% filter(!is.na(stage))
# stage_instructions_by_scene

# <speaker-stage> by <scene>
speaker_stage_instructions_by_scene <- all_plays %>%
  select(title, act, act_number, scene, scene_number, index, speaker_stage) %>% filter(!is.na(speaker_stage))
# speaker_stage_instructions_by_scene

# <stage> and <speaker-stage> by <scene>
instruction_by_scene <- bind_rows(stage_instructions_by_scene, speaker_stage_instructions_by_scene)
# instruction_by_scene

#instructions sorted by title, act number, scene number, index 
instruction_by_scene <- arrange(instruction_by_scene, title, act_number, scene_number, index)
instruction_by_scene

```


# Find alle speakers
Det skulle vi måske have gjort et andet sted, så vi nu bare kan hente dem.

```{r}
all_speakers_one <- one_play %>% 
  count(speaker)
all_speakers_one

all_speakers <- all_plays %>% 
  count(title, speaker)
all_speakers

# unite_speakers <- unite(all_speakers, sep = " ")
```

# Search for speakers in instructions
We will try using
* join
* fuzzyjoin
* purrr

Vi skal nok gøre det for hvert stykke for sig...

```{r}
(plays %>%
  filter(title == " Barselsstuen") %>%
  count(speaker) %>%
  mutate(speaker = str_to_lower(speaker)) %>%
  select(speaker) -> speakers_in_Barselstuen)
```
```{r}
library(tidytext)
```

```{r}
speakers_in_Barselstuen %>%
  filter(speaker == "claus")
```


```{r}
plays %>%
  filter(title == " Barselsstuen") %>%
  unnest_tokens(word, stage) %>%
  filter(!is.na(word)) %>%
  select(act, scene, index, word)
```


```{r}
plays %>%
  filter(title == " Barselsstuen") %>%
  unnest_tokens(word, stage) %>%
  filter(!is.na(word)) %>%
  select(act, scene, index, word) %>%
  semi_join(speakers_in_Barselstuen, by = c("word" = "speaker"))
```
Ovenstående må betyde at vi har 110 steder, hvor speaker er nævnt i en regi-bemærkning.




```{r}
library(tidytext)
# tokenize stage (and call tokens speaker)
tmp <- instruction_one_by_scene %>%
  unnest_tokens(speaker, stage) #%>%
#  unnest_tokens(speaker_stage_word, speaker_stage)
tmp

tmp %>% count(act_number, scene_number, speaker)
# semi-join: keep the rows in x that have a match in y
tmp2 <- tmp %>% 
  semi_join(all_speakers_one)
#all_speakers %>% semi_join(top_dest)
#> Joining, by = "dest"



#instruction_by_scene %>% select(ends_with("stage"))
tmp2
                                       
# str_detect(tmp[1], "Troels", negate = FALSE)
#detect(tmp, "Troels")


```

WORK IN PROGRESS

Først benyt dem vi véd er med i et givet stykke ud fra speakers 

Dernæst brug en bruttoliste over hvem der ville kunne være tilstede 

Denne bruttoliste kan måske baseres på "ordbogen" (se nedenfor) 

Den kan måske gives fra forskerne 